@using Fituska.Shared.Models.File
@typeparam TFileModel

<InputFile OnChange="OnInputFileChange" multiple="@(!ImageOnly)" />

@code
{
    [Parameter]
    public bool ImageOnly { get; set; }

    [Parameter]
    public TFileModel FileModel { get; set; }

    [Parameter]
    public Guid ParentId { get; set; }

    [Parameter]
    public EventCallback<byte[]> OnChange { get; set; }

    async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        //Read file and send byte[] content via OnChange, sending to endpoint by component parent.
        if (ImageOnly)
        {
            if (!e.File.ContentType.StartsWith("image/"))
                return;

            var imageFile = await e.File.RequestImageFileAsync(e.File.ContentType, 512, 512);
            var fileContent = new StreamContent(imageFile.OpenReadStream(imageFile.Size));

            await OnChange.InvokeAsync(await fileContent.ReadAsByteArrayAsync());
            return;
        }
        //Read multiple files into model.Content
        //TODO

        //Set File parent Id based on meant parent type.
        switch (FileModel)
        {
            case FileAnswerModel fileAnswerModel:
                fileAnswerModel.AnswerId = ParentId;
                break;
            case FileCommentModel fileCommentModel:
                fileCommentModel.CommentId = ParentId;
                break;
            case FileQuestionModel fileQuestionModel:
                fileQuestionModel.QuestionId = ParentId;
                break;
        }
    }
}
